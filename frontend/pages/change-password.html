<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Смена пароля - tickethub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Vollkorn:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <a href="../index.html" class="logo">tickethub</a>
            <div class="nav-links">
                <a href="tickets.html" class="nav-link">Билеты</a>
                <a href="events.html" class="nav-link">Мероприятия</a>
                <a href="booking-info.html" class="nav-link">Бронирование</a>
            </div>
            <div class="auth-section">
                <a href="login.html" class="login-btn" id="loginBtn">Войти</a>
                <div class="user-section" id="userSection" style="display: none;">
                    <span class="username" id="username"></span>
                    <button class="logout-btn" id="logoutBtn">Выйти</button>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="auth-container" style="min-height: auto; padding-top: 2rem;">
            <form class="auth-form" id="changePasswordForm">
                <h1 class="auth-title">Смена пароля</h1>
                
                <div class="form-group">
                    <label class="form-label" for="oldPassword">Старый пароль</label>
                    <input type="password" class="form-input" id="oldPassword" name="oldPassword" required>
                </div>
                
                <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-start;">
                    <div style="flex: 1;">
                        <label class="form-label" for="newPassword">Новый пароль</label>
                        <input type="password" class="form-input" id="newPassword" name="newPassword" maxlength="15" required>
                    </div>
                    <div class="password-requirements" id="passwordRequirements" style="min-width: 200px; padding-top: 1.5rem;">
                        <div class="requirement" id="reqUppercase">
                            <span class="requirement-icon invalid">✗</span>
                            <span class="requirement-text">Минимум 1 заглавная буква</span>
                        </div>
                        <div class="requirement" id="reqSpecial">
                            <span class="requirement-icon invalid">✗</span>
                            <span class="requirement-text">Минимум 1 спецсимвол</span>
                        </div>
                        <div class="requirement" id="reqDigits">
                            <span class="requirement-icon invalid">✗</span>
                            <span class="requirement-text">Минимум 2 цифры</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-start;">
                    <div style="flex: 1;">
                        <label class="form-label" for="confirmNewPassword">Повторите новый пароль</label>
                        <input type="password" class="form-input" id="confirmNewPassword" name="confirmNewPassword" maxlength="15" required>
                    </div>
                    <div id="passwordMatchError" class="error-text" style="display: none; padding-top: 2rem;">Пароли не совпадают</div>
                </div>
                
                <div id="message" style="display: none; margin-bottom: 1rem; font-size: 0.9rem;"></div>
                
                <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                    <button type="submit" class="submit-btn" id="submitBtn" disabled>Сменить пароль</button>
                </div>
            </form>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            if (!requireAuth()) return;
            
            const form = document.getElementById('changePasswordForm');
            const submitBtn = document.getElementById('submitBtn');
            const messageDiv = document.getElementById('message');
            
            const oldPasswordInput = document.getElementById('oldPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
            const passwordMatchError = document.getElementById('passwordMatchError');
            
            const reqUppercase = document.getElementById('reqUppercase');
            const reqSpecial = document.getElementById('reqSpecial');
            const reqDigits = document.getElementById('reqDigits');
            
            // Password validation
            function validatePassword(password) {
                const hasUppercase = /[A-ZА-ЯЁ]/.test(password);
                const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
                const digitCount = (password.match(/\d/g) || []).length;
                
                return {
                    hasUppercase,
                    hasSpecial,
                    hasDigits: digitCount >= 2,
                    isValid: hasUppercase && hasSpecial && digitCount >= 2
                };
            }
            
            // Update password requirements UI
            function updatePasswordRequirements() {
                const password = newPasswordInput.value;
                const validation = validatePassword(password);
                
                updateRequirement(reqUppercase, validation.hasUppercase);
                updateRequirement(reqSpecial, validation.hasSpecial);
                updateRequirement(reqDigits, validation.hasDigits);
            }
            
            function updateRequirement(element, isValid) {
                const icon = element.querySelector('.requirement-icon');
                if (isValid) {
                    icon.textContent = '✓';
                    icon.classList.remove('invalid');
                    icon.classList.add('valid');
                } else {
                    icon.textContent = '✗';
                    icon.classList.remove('valid');
                    icon.classList.add('invalid');
                }
            }
            
            // Check passwords match
            function checkPasswordsMatch() {
                const newPassword = newPasswordInput.value;
                const confirmNewPassword = confirmNewPasswordInput.value;
                
                if (confirmNewPassword.length > 0 && newPassword !== confirmNewPassword) {
                    passwordMatchError.style.display = 'block';
                    return false;
                } else {
                    passwordMatchError.style.display = 'none';
                    return true;
                }
            }
            
            // Full form validation
            function validateForm() {
                const oldPassword = oldPasswordInput.value;
                const newPassword = newPasswordInput.value;
                const confirmNewPassword = confirmNewPasswordInput.value;
                
                const passwordValidation = validatePassword(newPassword);
                const passwordsMatch = newPassword === confirmNewPassword;
                
                return oldPassword.length > 0 && 
                       passwordValidation.isValid && 
                       passwordsMatch &&
                       newPassword.length > 0;
            }
            
            // Update submit button state
            function updateSubmitButton() {
                submitBtn.disabled = !validateForm();
            }
            
            // Event listeners
            oldPasswordInput.addEventListener('input', updateSubmitButton);
            
            newPasswordInput.addEventListener('input', () => {
                updatePasswordRequirements();
                checkPasswordsMatch();
                updateSubmitButton();
            });
            
            confirmNewPasswordInput.addEventListener('input', () => {
                checkPasswordsMatch();
                updateSubmitButton();
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!validateForm()) return;
                
                const oldPassword = oldPasswordInput.value;
                const newPassword = newPasswordInput.value;
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Сохранение...';
                messageDiv.style.display = 'none';
                
                try {
                    const result = await authAPI.changePassword(oldPassword, newPassword);
                    
                    if (result && result.success) {
                        messageDiv.textContent = 'Пароль успешно изменен';
                        messageDiv.style.color = '#008000';
                        messageDiv.style.display = 'block';
                        
                        // Clear form
                        oldPasswordInput.value = '';
                        newPasswordInput.value = '';
                        confirmNewPasswordInput.value = '';
                        updatePasswordRequirements();
                    } else {
                        messageDiv.textContent = result?.error || 'Ошибка смены пароля';
                        messageDiv.style.color = '#800000';
                        messageDiv.style.display = 'block';
                    }
                } catch (error) {
                    messageDiv.textContent = 'Ошибка соединения с сервером';
                    messageDiv.style.color = '#800000';
                    messageDiv.style.display = 'block';
                }
                
                submitBtn.disabled = false;
                submitBtn.textContent = 'Сменить пароль';
                updateSubmitButton();
            });
            
            updatePasswordRequirements();
            updateSubmitButton();
        });
    </script>
</body>
</html>
