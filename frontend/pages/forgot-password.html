<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Восстановление пароля - tickethub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Vollkorn:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="auth-container">
        <form class="auth-form" id="forgotForm" style="max-width: 550px;">
            <a href="../index.html" class="auth-logo">tickethub</a>
            <h1 class="auth-title">Восстановление пароля</h1>
            
            <!-- Step 1: Login and Email -->
            <div id="step1">
                <div class="form-group">
                    <label class="form-label" for="login">Логин</label>
                    <input type="text" class="form-input" id="login" name="login" maxlength="15" required>
                </div>
                
                <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-start;">
                    <div style="flex: 1;">
                        <label class="form-label" for="email">Электронная почта</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="email" class="form-input" id="email" name="email" required style="flex: 1;">
                            <button type="button" class="submit-btn" id="sendCodeBtn" style="white-space: nowrap; padding: 0.5rem 1rem; font-size: 0.9rem;">Получить код</button>
                        </div>
                    </div>
                    <div id="emailError" class="error-text" style="display: none; padding-top: 2rem;">Неверный формат</div>
                </div>
                
                <div id="codeMessageStep1" style="display: none; margin-bottom: 1rem; font-size: 0.9rem;"></div>
            </div>
            
            <!-- Step 2: Verification Code -->
            <div id="step2" style="display: none;">
                <div class="form-group">
                    <label class="form-label" for="verificationCode">Код подтверждения</label>
                    <input type="text" class="form-input" id="verificationCode" name="verificationCode" maxlength="6" placeholder="6 цифр">
                    <p id="codeMessage" style="color: #008000; font-size: 0.9rem; margin-top: 0.5rem;"></p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <span id="resendTimer" style="color: #808080; font-size: 0.9rem;"></span>
                    <button type="button" id="resendCodeBtn" style="background: none; border: none; color: white; cursor: pointer; font-size: 0.9rem; text-decoration: underline; display: none;">Отправить повторно</button>
                </div>
                
                <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                    <button type="button" class="submit-btn" id="verifyCodeBtn" disabled>Подтвердить код</button>
                </div>
            </div>
            
            <!-- Step 3: New Password -->
            <div id="step3" style="display: none;">
                <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-start;">
                    <div style="flex: 1;">
                        <label class="form-label" for="newPassword">Новый пароль</label>
                        <input type="password" class="form-input" id="newPassword" name="newPassword" maxlength="15" required>
                    </div>
                    <div class="password-requirements" id="passwordRequirements" style="min-width: 200px; padding-top: 0; margin-top: 1.75rem;">
                        <div class="requirement" id="reqUppercase">
                            <span class="requirement-icon invalid">✗</span>
                            <span class="requirement-text">Минимум 1 заглавная буква</span>
                        </div>
                        <div class="requirement" id="reqSpecial">
                            <span class="requirement-icon invalid">✗</span>
                            <span class="requirement-text">Минимум 1 спецсимвол</span>
                        </div>
                        <div class="requirement" id="reqDigits">
                            <span class="requirement-icon invalid">✗</span>
                            <span class="requirement-text">Минимум 2 цифры</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-start;">
                    <div style="flex: 1;">
                        <label class="form-label" for="confirmPassword">Повторите пароль</label>
                        <input type="password" class="form-input" id="confirmPassword" name="confirmPassword" maxlength="15" required>
                    </div>
                    <div id="passwordMatchError" class="error-text" style="display: none; padding-top: 2rem;">Пароли не совпадают</div>
                </div>
                
                <div id="errorMessage" class="error-text" style="display: none; margin-bottom: 1rem;"></div>
                
                <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                    <button type="button" class="submit-btn" id="changePasswordBtn" disabled>Сменить пароль</button>
                </div>
            </div>
            
            <!-- Success message -->
            <div id="successMessage" style="display: none; text-align: center; color: #008000; margin-bottom: 1rem;"></div>
            
            <div class="auth-footer">
                <a href="login.html" class="auth-footer-link">Вернуться ко входу</a>
            </div>
        </form>
    </div>

    <script src="../js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elements
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const successMessage = document.getElementById('successMessage');
            
            const loginInput = document.getElementById('login');
            const emailInput = document.getElementById('email');
            const sendCodeBtn = document.getElementById('sendCodeBtn');
            const emailError = document.getElementById('emailError');
            const codeMessageStep1 = document.getElementById('codeMessageStep1');
            
            const verificationCodeInput = document.getElementById('verificationCode');
            const codeMessage = document.getElementById('codeMessage');
            const verifyCodeBtn = document.getElementById('verifyCodeBtn');
            const resendTimer = document.getElementById('resendTimer');
            const resendCodeBtn = document.getElementById('resendCodeBtn');
            
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const passwordMatchError = document.getElementById('passwordMatchError');
            const errorMessage = document.getElementById('errorMessage');
            
            const reqUppercase = document.getElementById('reqUppercase');
            const reqSpecial = document.getElementById('reqSpecial');
            const reqDigits = document.getElementById('reqDigits');
            
            let resendCountdown = 0;
            let countdownInterval = null;
            
            // Email validation
            function validateEmail(email) {
                const specialCharsRegex = /[!?'№#$%^&*()+=\[\]{};:"\\|,<>\/`~]/;
                if (specialCharsRegex.test(email)) return false;
                
                const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (!emailRegex.test(email)) return false;
                
                const atCount = (email.match(/@/g) || []).length;
                if (atCount !== 1) return false;
                
                const validDomains = ['@yandex.ru', '@mail.ru', '@gmail.com', '@google.com'];
                return validDomains.some(domain => email.toLowerCase().endsWith(domain));
            }
            
            // Password validation
            function validatePassword(password) {
                const hasUppercase = /[A-ZА-ЯЁ]/.test(password);
                const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
                const digitCount = (password.match(/\d/g) || []).length;
                
                return {
                    hasUppercase,
                    hasSpecial,
                    hasDigits: digitCount >= 2,
                    isValid: hasUppercase && hasSpecial && digitCount >= 2
                };
            }
            
            function updateRequirement(element, isValid) {
                const icon = element.querySelector('.requirement-icon');
                if (isValid) {
                    icon.textContent = '✓';
                    icon.classList.remove('invalid');
                    icon.classList.add('valid');
                } else {
                    icon.textContent = '✗';
                    icon.classList.remove('valid');
                    icon.classList.add('invalid');
                }
            }
            
            function updatePasswordRequirements() {
                const password = newPasswordInput.value;
                const validation = validatePassword(password);
                
                updateRequirement(reqUppercase, validation.hasUppercase);
                updateRequirement(reqSpecial, validation.hasSpecial);
                updateRequirement(reqDigits, validation.hasDigits);
            }
            
            function checkPasswordsMatch() {
                const password = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                if (confirmPassword.length > 0 && password !== confirmPassword) {
                    passwordMatchError.style.display = 'block';
                    return false;
                } else {
                    passwordMatchError.style.display = 'none';
                    return true;
                }
            }
            
            function updateChangePasswordBtn() {
                const password = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                const validation = validatePassword(password);
                
                changePasswordBtn.disabled = !(validation.isValid && password === confirmPassword && password.length > 0);
            }
            
            // Start resend countdown
            function startResendCountdown() {
                resendCountdown = 60;
                resendCodeBtn.style.display = 'none';
                resendTimer.style.display = 'inline';
                resendTimer.textContent = `Отправить повторно через ${resendCountdown} сек`;
                
                if (countdownInterval) clearInterval(countdownInterval);
                
                countdownInterval = setInterval(() => {
                    resendCountdown--;
                    if (resendCountdown <= 0) {
                        clearInterval(countdownInterval);
                        resendTimer.style.display = 'none';
                        resendCodeBtn.style.display = 'inline';
                    } else {
                        resendTimer.textContent = `Отправить повторно через ${resendCountdown} сек`;
                    }
                }, 1000);
            }
            
            // Check email on input
            emailInput.addEventListener('input', () => {
                const email = emailInput.value.trim();
                if (email.length > 0 && !validateEmail(email)) {
                    emailError.style.display = 'block';
                } else {
                    emailError.style.display = 'none';
                }
            });
            
            // Send verification code
            sendCodeBtn.addEventListener('click', async () => {
                const login = loginInput.value.trim();
                const email = emailInput.value.trim();
                
                if (!login) {
                    codeMessageStep1.textContent = 'Введите логин';
                    codeMessageStep1.style.color = '#800000';
                    codeMessageStep1.style.display = 'block';
                    return;
                }
                
                if (!validateEmail(email)) {
                    emailError.style.display = 'block';
                    return;
                }
                
                sendCodeBtn.disabled = true;
                sendCodeBtn.textContent = 'Проверка...';
                codeMessageStep1.style.display = 'none';
                
                try {
                    // First verify that user exists
                    const verifyResult = await authAPI.verifyUserExists(login, email);
                    
                    if (!verifyResult || !verifyResult.success) {
                        codeMessageStep1.textContent = verifyResult?.error || 'Пользователь с таким логином и почтой не найден';
                        codeMessageStep1.style.color = '#800000';
                        codeMessageStep1.style.display = 'block';
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.textContent = 'Получить код';
                        return;
                    }
                    
                    // Send verification code
                    const result = await authAPI.sendVerificationCode(email);
                    
                    if (result && result.success) {
                        step1.style.display = 'none';
                        step2.style.display = 'block';
                        codeMessage.textContent = 'Код подтверждения отправлен на указанную почту';
                        codeMessage.style.color = '#008000';
                        startResendCountdown();
                    } else {
                        codeMessageStep1.textContent = result?.error || 'Ошибка отправки кода';
                        codeMessageStep1.style.color = '#800000';
                        codeMessageStep1.style.display = 'block';
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.textContent = 'Получить код';
                    }
                } catch (error) {
                    codeMessageStep1.textContent = 'Ошибка соединения с сервером';
                    codeMessageStep1.style.color = '#800000';
                    codeMessageStep1.style.display = 'block';
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.textContent = 'Получить код';
                }
            });
            
            // Resend code
            resendCodeBtn.addEventListener('click', async () => {
                const email = emailInput.value.trim();
                
                resendCodeBtn.style.display = 'none';
                resendTimer.textContent = 'Отправка...';
                resendTimer.style.display = 'inline';
                
                try {
                    const result = await authAPI.sendVerificationCode(email);
                    
                    if (result && result.success) {
                        codeMessage.textContent = 'Код подтверждения отправлен повторно';
                        codeMessage.style.color = '#008000';
                        startResendCountdown();
                    } else {
                        codeMessage.textContent = result?.error || 'Ошибка отправки кода';
                        codeMessage.style.color = '#800000';
                        resendCodeBtn.style.display = 'inline';
                        resendTimer.style.display = 'none';
                    }
                } catch (error) {
                    codeMessage.textContent = 'Ошибка соединения с сервером';
                    codeMessage.style.color = '#800000';
                    resendCodeBtn.style.display = 'inline';
                    resendTimer.style.display = 'none';
                }
            });
            
            // Enable verify button when code is 6 digits
            verificationCodeInput.addEventListener('input', () => {
                verifyCodeBtn.disabled = verificationCodeInput.value.trim().length !== 6;
            });
            
            // Verify code
            verifyCodeBtn.addEventListener('click', async () => {
                const email = emailInput.value.trim();
                const code = verificationCodeInput.value.trim();
                
                verifyCodeBtn.disabled = true;
                verifyCodeBtn.textContent = 'Проверка...';
                
                try {
                    const result = await authAPI.verifyCode(email, code);
                    
                    if (result && result.success) {
                        step2.style.display = 'none';
                        step3.style.display = 'block';
                    } else {
                        codeMessage.textContent = result?.error || 'Неверный код подтверждения';
                        codeMessage.style.color = '#800000';
                        verifyCodeBtn.disabled = false;
                        verifyCodeBtn.textContent = 'Подтвердить код';
                    }
                } catch (error) {
                    codeMessage.textContent = 'Ошибка соединения с сервером';
                    codeMessage.style.color = '#800000';
                    verifyCodeBtn.disabled = false;
                    verifyCodeBtn.textContent = 'Подтвердить код';
                }
            });
            
            // Password inputs
            newPasswordInput.addEventListener('input', () => {
                updatePasswordRequirements();
                checkPasswordsMatch();
                updateChangePasswordBtn();
            });
            
            confirmPasswordInput.addEventListener('input', () => {
                checkPasswordsMatch();
                updateChangePasswordBtn();
            });
            
            // Change password
            changePasswordBtn.addEventListener('click', async () => {
                const login = loginInput.value.trim();
                const email = emailInput.value.trim();
                const newPassword = newPasswordInput.value;
                
                changePasswordBtn.disabled = true;
                changePasswordBtn.textContent = 'Сохранение...';
                errorMessage.style.display = 'none';
                
                try {
                    const result = await authAPI.resetPassword(login, email, newPassword);
                    
                    if (result && result.success) {
                        step3.style.display = 'none';
                        successMessage.textContent = 'Пароль успешно изменен! Теперь вы можете войти с новым паролем.';
                        successMessage.style.display = 'block';
                    } else {
                        errorMessage.textContent = result?.error || 'Ошибка смены пароля';
                        errorMessage.style.display = 'block';
                        changePasswordBtn.disabled = false;
                        changePasswordBtn.textContent = 'Сменить пароль';
                    }
                } catch (error) {
                    errorMessage.textContent = 'Ошибка соединения с сервером';
                    errorMessage.style.display = 'block';
                    changePasswordBtn.disabled = false;
                    changePasswordBtn.textContent = 'Сменить пароль';
                }
            });
            
            updatePasswordRequirements();
        });
    </script>
</body>
</html>
